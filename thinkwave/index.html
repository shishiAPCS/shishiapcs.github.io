<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RosterFlow ‚Äî ThinkWave Organizer</title>
<style>
  :root{
    --bg: #0f1420; --panel:#171e2b; --soft:#1e2636; --text:#eaf0ff; --muted:#aab6d6; --chip:#202a3f; --accent:#5aa7ff; --ok:#3ccf8e; --warn:#f0a93b; --bad:#ff6b6b; --stroke:#23304a;
  }
  [data-theme="light"]{
    --bg:#f6f7fb; --panel:#ffffff; --soft:#f1f4fa; --text:#0b1322; --muted:#46546f; --chip:#e9eef7; --accent:#2a7fff; --ok:#0fa36b; --warn:#cb7a12; --bad:#d94242; --stroke:#dde3ef;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
  .page{max-width:1160px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:24px;height:24px;display:grid;place-items:center;border-radius:8px;background:linear-gradient(180deg, var(--accent), #6fe3ff)}
  .brand h1{font-size:18px;margin:0}
  .subtitle{opacity:.6}
  .spacer{flex:1}
  .theme{display:inline-flex;align-items:center;gap:8px;background:var(--soft);border:1px solid var(--stroke);border-radius:999px;padding:6px 10px}
  .theme button{background:none;border:0;color:var(--text);opacity:.7;padding:4px 8px;border-radius:8px;cursor:pointer}
  .theme button.active{opacity:1;background:var(--chip)}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:16px}
  .card h2{font-size:16px;margin:0 0 12px 0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .btn{background:var(--soft);border:1px solid var(--stroke);color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.tonal{background:var(--chip)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);cursor:pointer;opacity:.9}
  .chip.active{outline:2px solid var(--accent);opacity:1}

  .roster{display:flex;flex-direction:column;gap:8px;max-height:280px;overflow:auto;border:1px solid var(--stroke);border-radius:10px}
  .row{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;background:var(--soft);border-bottom:1px solid var(--stroke)}
  .row:last-child{border-bottom:0}
  .hint{font-size:12px;color:var(--muted);margin:10px 0}
  textarea{width:100%;min-height:160px;resize:vertical;border-radius:10px;background:var(--soft);border:1px solid var(--stroke);color:var(--text);padding:10px;font:13px/1.5 ui-monospace,SFMono-Regular,Consolas,Monaco,Menlo,monospace}
  .smallbox{min-height:110px}
  .rowctrls{display:flex;gap:8px;margin-top:8px}

  .kpis{display:flex;gap:10px;margin-top:8px;align-items:center;flex-wrap:wrap}
  .pill{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid var(--stroke);background:var(--soft);display:inline-flex;gap:6px;align-items:center}
  .ok{background:rgba(60,207,142,.12);border-color:rgba(60,207,142,.4)}
  .bad{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.4)}
  .warn{background:rgba(240,169,59,.12);border-color:rgba(240,169,59,.4)}

  details{margin-top:6px}
  details pre{background:var(--soft);border:1px solid var(--stroke);border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word}

  .full{grid-column:1/-1}
  .preview{min-height:140px}
  .footer{opacity:.6;font-size:12px;margin-top:10px}
  .right{display:flex;justify-content:flex-end}

  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) scale(.98);background:var(--panel);color:var(--text);border:1px solid var(--stroke);padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s;z-index:800}
  .toast.show{opacity:1;transform:translateX(-50%) scale(1)}

  /* Inline areas */
  .orderarea,.adhocarea{display:none;margin:8px 0}
  .orderarea.active,.adhocarea.active{display:block}

  @media (max-width: 920px){
    .grid{grid-template-columns:1fr}
  }

  #btnPasteOrder, .orderbar, #orderArea { display:none !important; }
</style>
</head>
<body>
<div class="page">
  <header>
    <div class="brand">
      <div class="logo">„äôÔ∏è</div>
      <div>
        <h1 style="margin:0">RosterFlow</h1>
        <div class="subtitle">ThinkWave Organizer</div>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="theme" id="themeCtl" title="Theme">
      <button data-mode="auto" class="active" aria-pressed="true" title="Auto">‚öôÔ∏é&nbsp;Auto</button>
      <button data-mode="light" title="Light">‚òÄÔ∏è&nbsp;Light</button>
      <button data-mode="dark" title="Dark">üåô&nbsp;Dark</button>
    </div>
  </header>

  <div class="grid">
    <!-- Left: Roster -->
    <section class="card" id="cardRoster">
      <h2>1) Roster</h2>
      <div class="toolbar">
        <label class="btn" for="fileJson">Import JSON</label>
        <input type="file" id="fileJson" accept="application/json" hidden />
        <button class="btn" id="btnClearCache">Clear Cache</button>
        <button class="btn" id="btnPasteOrder">Paste Roster Order</button>
        <button class="btn" id="btnAdhoc">Ad-hoc List</button>
      </div>
      <div class="chips" id="subjectChips"></div>

      <!-- Paste Roster Order (subject-only helper) -->
      <div class="orderarea" id="orderArea">
        <div class="hint">Custom order for the selected subject ‚Äî one student per line. Examples: <code>Li, Xiaoduan "Minato"</code> ¬∑ <code>Minato Li</code> ¬∑ <code>Tom Z</code> ¬∑ <code>TomZ</code></div>
        <textarea class="smallbox" id="orderInput" placeholder="Minato&#10;Joe&#10;George&#10;..."></textarea>
        <div class="rowctrls right">
          <button class="btn" id="btnApplyOrder">Use this order</button>
        </div>
      </div>

      <!-- Ad-hoc roster (replaces subject roster while active) -->
      <div class="adhocarea" id="adhocArea">
        <div class="hint">Ad-hoc list: paste any names (one per line). This replaces the subject roster for this session.</div>
        <textarea class="smallbox" id="adhocInput" placeholder="George&#10;Selina&#10;Joe"></textarea>
        <div class="rowctrls right">
          <button class="btn" id="btnUseAdhoc">Use ad-hoc roster</button>
          <button class="btn" id="btnClearAdhoc">Clear</button>
        </div>
      </div>

      <div class="roster" id="rosterList"></div>
    </section>

    <!-- Right: Scores Paste -->
    <section class="card" id="cardScores">
      <h2>2) Paste Scores</h2>
      <div class="hint">Accepts <b>Name,Score</b> ¬∑ <b>Name Score</b> ¬∑ <b>Name ‚Ä¶ Score</b>. The last number on each line is used.</div>
      <textarea id="scoresInput" placeholder="Joe 99&#10;Selina 95&#10;George 97&#10;..."></textarea>
      <div class="rowctrls">
        <button class="btn" id="btnOrganize">Organize into Roster Order</button>
        <button class="btn tonal" id="btnToefl">Convert TOEFL ‚Üí GPA (0‚Äì30 ‚Üí 55‚Äì100)</button>
        <button class="btn tonal" id="btnIelts">Convert IELTS ‚Üí GPA (1‚Äì9 ‚Üí 55‚Äì100)</button>

      </div>
      <div class="kpis">
        <div class="pill ok" id="kMatch">‚úî Matches 0/0</div>
        <div class="pill warn" id="kAmb">‚ùì Ambiguous 0</div>
        <div class="pill bad" id="kUnmatch">‚ùó Unmatched 0</div>
      </div>
      <details id="detailBox"><summary>See ambiguous/unmatched details</summary>
        <pre id="detailText"></pre>
      </details>
    </section>

    <!-- Bottom full: Results -->
    <section class="card full">
      <h2>3) Results</h2>
      <div class="hint">CSV Preview</div>
      <textarea class="preview" id="csvOut" readonly></textarea>
      <div class="rowctrls">
        <button class="btn" id="btnDownload">Download CSV</button>
      </div>
      <div class="footer">Tip: Open ThinkWave assignment page ‚Üí Right-click ‚Üí Inspect ‚Üí Console ‚Üí Cmd/Ctrl+V ‚Üí Enter.</div>
    </section>
  </div>
</div>

<div class="toast" id="toast">Copied to clipboard</div>

<script>
(() => {
  // THEME /////////////////////////////////////////////////////////////////
  const themeCtl = document.getElementById('themeCtl');
  const themeBtns = [...themeCtl.querySelectorAll('button')];
  const lsKeyTheme = 'rf_theme_pref';
  const setTheme = (mode) => {
    document.documentElement.removeAttribute('data-theme');
    if (mode === 'dark') document.documentElement.setAttribute('data-theme','dark');
    if (mode === 'light') document.documentElement.setAttribute('data-theme','light');
    localStorage.setItem(lsKeyTheme, mode);
    themeBtns.forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
  };
  themeCtl.addEventListener('click', (e)=> {
    const b = e.target.closest('button'); if (!b) return;
    setTheme(b.dataset.mode);
  });
  setTheme(localStorage.getItem(lsKeyTheme)||'auto');

  // DATA //////////////////////////////////////////////////////////////////
  const els = {
    chips: document.getElementById('subjectChips'),
    rosterList: document.getElementById('rosterList'),
    file: document.getElementById('fileJson'),
    clearCache: document.getElementById('btnClearCache'),
    scoresInput: document.getElementById('scoresInput'),
    btnOrganize: document.getElementById('btnOrganize'),
    btnToefl: document.getElementById('btnToefl'),
    btnIelts: document.getElementById('btnIelts'),
    csvOut: document.getElementById('csvOut'),
    btnDownload: document.getElementById('btnDownload'),
    detailText: document.getElementById('detailText'),
    kMatch: document.getElementById('kMatch'),
    kAmb: document.getElementById('kAmb'),
    kUn: document.getElementById('kUnmatch'),
    btnPasteOrder: document.getElementById('btnPasteOrder'),
    orderArea: document.getElementById('orderArea'),
    orderInput: document.getElementById('orderInput'),
    btnApplyOrder: document.getElementById('btnApplyOrder'),
    // Ad-hoc
    btnAdhoc: document.getElementById('btnAdhoc'),
    adhocArea: document.getElementById('adhocArea'),
    adhocInput: document.getElementById('adhocInput'),
    btnUseAdhoc: document.getElementById('btnUseAdhoc'),
    btnClearAdhoc: document.getElementById('btnClearAdhoc'),
  };

  const cacheKey = 'tw_rosters_v1';
  let data = null;               // loaded JSON
  let activeSubject = null;      // subject object
  let roster = [];               // current roster array (subject or ad-hoc)
  let rosterKeys = [];           // computed key per student
  let orderOverride = null;      // {lines:string[], map:int[]}
  const adhoc = { active:false, lines:[] };

  let lastSubjectId = null; // remember the most recent subject so we can restore it after Ad-hoc


  // UTIL /////////////////////////////////////////////////////////////////
  const toast = (msg) => { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400); };
  const tidy = (s) => (s||'').toString().replace(/[\u201C\u201D\u2018\u2019]/g,'"').replace(/[\t\r]/g,' ').replace(/\s+/g,' ').trim();
  const letters = (s) => (s||'').toLowerCase().normalize('NFD').replace(/[^a-z0-9]/g,'');
  const lastNumber = (line) => { const m = String(line).match(/(-?\d+(?:\.\d+)?)(?!.*\d)/); return m?m[1]:''; };

  const kFromStudent = (st) => {
    // Build multiple candidate keys for robust matching
    const disp = tidy(st.display||'');
    const eng = tidy(st.english||'');
    const fam = tidy(st.family||'');
    const giv = tidy(st.given||'');

    const keys = new Set();
    if (st.key) keys.add(letters(st.key));

    const q = disp.match(/"(.*?)"/); // nickname inside quotes
    const nick = q ? tidy(q[1]) : '';
    const main = disp.replace(/".*?"/g,'').replace(/\s+,\s+/g,',').trim();
    let fam2 = fam, giv2 = giv;
    if (!fam2 || !giv2){
      if (main.includes(',')){
        const parts = main.split(',').map(s=>s.trim()).filter(Boolean);
        fam2 = fam2 || parts[0] || '';
        giv2 = giv2 || parts[1] || '';
      } else {
        const parts = main.split(/\s+/); fam2 = fam2 || (parts.pop()||''); giv2 = giv2 || parts.join(' ');
      }
    }

    const add = v => { v=(v||'').trim(); if (v) keys.add(letters(v)); };
    add(eng); add(nick);
    add(`${eng} ${fam2}`);
    add(`${eng}${fam2}`);
    add(`${giv2} ${fam2}`);
    add(`${fam2} ${giv2}`);
    add(`${giv2}${fam2}`);
    add(`${fam2}${giv2}`);
    if (fam2) add(`${eng} ${fam2[0]}`);
    return Array.from(keys);
  };

  const kFromAnyName = (raw) => {
    const s = tidy(raw);
    const q = s.match(/"(.*?)"/);
    const nick = q ? q[1] : '';
    const strip = s.replace(/".*?"/g,'').trim();
    let fam='', giv='', eng='';
    if (strip.includes(',')){
      const parts = strip.split(',').map(p=>p.trim());
      fam = parts[0]||''; giv = parts[1]||''; eng = parts[2]||'';
    } else {
      const parts = strip.split(/\s+/).filter(Boolean);
      if (parts.length>=2){
        giv = parts.slice(0,-1).join(' ');
        fam = parts.slice(-1)[0];
      } else {
        eng = strip;
      }
    }
    const set = new Set();
    const add = v=>{ v=(v||'').trim(); if(v) set.add(letters(v)); };
    add(eng||nick||strip);
    add(`${eng} ${fam}`);
    add(`${giv} ${fam}`);
    add(`${fam} ${giv}`);
    add(`${eng}${fam}`);
    add(`${giv}${fam}`);
    if (fam) add(`${eng} ${fam[0]}`);
    return Array.from(set);
  };

  const pickBestMatch = (nameRaw, rosterKeysArr) => {
    const keys = kFromAnyName(nameRaw);
    let hit = -1, multi = false;
    for (let i=0;i<rosterKeysArr.length;i++){
      const set = rosterKeysArr[i];
      for (const k of keys){ if (set.has(k)) { if (hit===-1) hit=i; else multi=true; } }
    }
    return {index: hit, ambiguous: multi};
  };

  const refreshRosterUI = () => {
    els.rosterList.innerHTML = '';
    roster.forEach(st => {
      const row = document.createElement('div'); row.className='row';
      const who = document.createElement('div'); who.textContent = st.display || `${st.family||''}${st.given?(', '+st.given):''}`.trim();
      const eng = document.createElement('div'); eng.textContent = tidy(st.english||''); eng.style.opacity='.6';
      row.append(who, eng); els.rosterList.append(row);
    });
  };

  const buildRosterKeys = () => {
    rosterKeys = roster.map(st=> new Set(kFromStudent(st)) );
  };

  const loadSubjects = () => {
    els.chips.innerHTML = '';
    if (!data || !Array.isArray(data.subjects)) return;
    data.subjects.forEach((s)=>{
      const b = document.createElement('div'); b.className='chip'; b.textContent = s.name; b.dataset.sid=s.id;
      b.addEventListener('click', ()=>selectSubject(s.id));
      els.chips.append(b);
    });
  };

  const markActiveChip = (sid) => {
    [...els.chips.children].forEach(c=>c.classList.toggle('active', c.dataset.sid===sid));
  };

  const selectSubject = (sid) => {
    lastSubjectId = sid;                 // <‚Äî remember last subject
    // Selecting a subject exits ad-hoc mode
    adhoc.active = false;
    adhoc.lines = [];
    activeSubject = (data.subjects||[]).find(s=>String(s.id)===String(sid));
    if (!activeSubject){ roster=[]; refreshRosterUI(); return; }
    roster = (activeSubject.roster||[]).filter(r=>r && (r.display||r.english||r.family));
    buildRosterKeys();
    markActiveChip(activeSubject.id);
    refreshRosterUI();
    // re-evaluate matches with any existing paste
    if (els.scoresInput.value.trim()) organize(false);
  };

  // ORDER OVERRIDE (session-only; no UI chrome) //////////////////////////
  const recomputeOrderMap = () => {
    if (!orderOverride || !Array.isArray(orderOverride.lines)) { orderOverride=null; return; }
    const used = new Set();
    const map = [];
    const unknown = [];
    let dup = [];
    orderOverride.lines.forEach(line=>{
      const {index} = pickBestMatch(line, rosterKeys);
      if (index===-1) { unknown.push(line); return; }
      if (used.has(index)) { dup.push(line); return; }
      used.add(index); map.push(index);
    });
    // Append remainder after listed names
    for(let i=0;i<roster.length;i++){ if(!used.has(i)) map.push(i); }
    orderOverride.map = map; orderOverride.unknown = unknown; orderOverride.dup = dup;
  };

  // SCORE PARSE & ORGANIZE //////////////////////////////////////////////
  const parseScores = (text) => {
    const lines = text.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const entries = [];
    for (const line of lines){
      const score = lastNumber(line);
      const name = line.replace(new RegExp(score.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+"$"), '').trim().replace(/[ ,]+$/,'');
      if (!name) continue;
      entries.push({raw: line, name, score});
    }
    return entries;
  };

  const buildNameToScoreMap = (entries) => {
    const keyMap = new Map();
    const amb = [];
    const un = [];
    let matches = 0;
    for (const e of entries){
      const {index, ambiguous} = pickBestMatch(e.name, rosterKeys);
      if (index===-1){ un.push(`- ${e.name} (${e.score})`); continue; }
      if (ambiguous) amb.push(`- ${e.name} (${e.score}) ‚Üí multiple matches`);
      keyMap.set(index, e.score); matches++;
    }
    return {keyMap, matches, amb, un};
  };

// NOTE: second arg is now an optional converter function (e.g., toGpa or ieltsToGpa)
const organize = (copyToClipboard = true, scoreConverter = null) => {
  if (!activeSubject && !adhoc.active){ toast('Load a roster or use Ad-hoc List.'); return; }

  // Parse scores once, optionally convert to GPA (non-destructive)
  const entries = parseScores(els.scoresInput.value);
  if (typeof scoreConverter === 'function') {
    entries.forEach(e => { e.score = String(scoreConverter(e.score)); });
  }

  const {keyMap, matches, amb, un} = buildNameToScoreMap(entries);

  // Build order: ad-hoc/subject default order, or custom map if provided
  let orderIdx = [...Array(roster.length).keys()];
  if (orderOverride && Array.isArray(orderOverride.map) && orderOverride.map.length) orderIdx = orderOverride.map.slice();

  // CSV output
  let csv = 'Name,Score\n';
  for (const i of orderIdx){
    const st = roster[i];
    const nm = tidy(st.display||`${st.family||''}${st.given?(', '+st.given):''}`.trim());
    const val = keyMap.has(i) ? keyMap.get(i) : '';
    const nameCsv = '"'+nm.replace(/"/g,'""')+'"';
    csv += `${nameCsv},${val}\n`;
  }
  els.csvOut.value = csv;

  // Details
  const det = [];
  if (orderOverride && (orderOverride.unknown?.length || orderOverride.dup?.length)){
    if (orderOverride.unknown?.length){ det.push('ORDER INPUT ‚Äî Unknown (ignored):'); orderOverride.unknown.forEach(x=>det.push(`- ${x}`)); det.push(''); }
    if (orderOverride.dup?.length){ det.push('ORDER INPUT ‚Äî Duplicates (last one kept):'); orderOverride.dup.forEach(x=>det.push(`- ${x}`)); det.push(''); }
  }
  if (amb.length){ det.push('SCORES INPUT ‚Äî Ambiguous:'); amb.forEach(x=>det.push(x)); det.push(''); }
  if (un.length){ det.push('SCORES INPUT ‚Äî Unmatched:'); un.forEach(x=>det.push(x)); }
  els.detailText.textContent = det.join('\n');

  els.kMatch.textContent = `‚úî Matches ${matches}/${entries.length}`;
  els.kAmb.textContent   = `‚ùì Ambiguous ${amb.length}`;
  els.kUn.textContent    = `‚ùó Unmatched ${un.length}`;

  // Autofill code version 1.0
//   const code = buildAutofillCode(entries);
//   if (copyToClipboard){ navigator.clipboard.writeText(code).then(()=>toast('Autofill code copied ‚úì')); }
// };


  // Autofill code 2.0 (use the possibly-converted entries)
  const code = buildAutofillCode(entries);
  if (copyToClipboard){
    (navigator.clipboard && navigator.clipboard.writeText
      ? navigator.clipboard.writeText(code)
      : Promise.reject(new Error('Clipboard API unavailable')))
    .then(() => toast('Autofill code copied ‚úì'))
    .catch((err) => {
      console.warn('Clipboard copy failed:', err);
      toast('Couldn‚Äôt copy ‚Äî open Console to copy the code.');
      console.log(code); // fallback: log the code so you can copy from DevTools
    });
  }
};




  // AUTOFILL CODE for ThinkWave assignments/gradebook ////////////////////
  const buildAutofillCode = (entries) => {
    // Build a richer mapping: all candidate keys ‚Üí score (skip empty keys)
    const lettersL = s => (s||'').toLowerCase().normalize('NFD').replace(/[^a-z0-9]/g,'');
    const keysFromAnyName = (raw) => {
      const s = String(raw||'').replace(/[\u201C\u201D\u2018\u2019]/g,'"').trim();
      const q = s.match(/"(.*?)"/);
      const nick = q ? q[1].trim() : '';
      const strip = s.replace(/".*?"/g,'').trim();
      let fam='', giv='', eng='';
      if (strip.includes(',')){
        const parts = strip.split(',').map(p=>p.replace(/,+$/,'').trim()).filter(Boolean);
        fam = parts[0]||''; giv = parts[1]||''; eng = parts[2]||'';
      } else {
        const parts = strip.split(/\s+/).filter(Boolean);
        if (parts.length>=2){ giv = parts.slice(0,-1).join(' '); fam = parts.slice(-1)[0]; }
        else { eng = strip; }
      }
      const set = new Set(), add=v=>{ v=(v||'').trim(); if(v) set.add(lettersL(v)); };
      add(eng||nick||strip);
      add(`${eng} ${fam}`); add(`${giv} ${fam}`); add(`${fam} ${giv}`);
      add(`${eng}${fam}`);  add(`${giv}${fam}`);
      if (fam){ add(`${eng} ${fam[0]}`); add(`${giv} ${fam[0]}`); add(`${eng}${fam[0]}`); add(`${giv}${fam[0]}`); }
      return Array.from(set);
    };

    const obj = {};
    for (const e of entries){
      const ks = keysFromAnyName(e.name);
      if (!ks.length) ks.push(lettersL(e.name));
      for (const k of ks){ if(k) obj[k] = String(e.score); } // guard against ""
    }
    const payload = JSON.stringify(obj);

    return `
(() => {
  const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[^a-z0-9]/g,'');
  const keyMap = ${payload};

  function parseDisp(disp){
    let d = String(disp||'').trim().replace(/\\s+/g,' ');
    const q = d.match(/["‚Äú](.*?)["‚Äù]/);
    let eng = q ? q[1].trim() : '';
    const withoutQuotes = d.replace(/".*?"/g,'').replace(/\\s*,\\s*$/,'').trim();
    let fam='', giv='';
    if (withoutQuotes.includes(',')){
      const parts = withoutQuotes.split(',').map(s => s.replace(/,+$/,'').trim()).filter(Boolean);
      fam = parts[0]||''; giv = parts[1]||'';
      if (!eng && parts.length>=3 && /^[A-Za-z .'-]+$/.test(parts[2])) eng = parts[2].trim();
    } else {
      const p = withoutQuotes.split(/\\s+/).filter(Boolean);
      fam = p.pop()||''; giv = p.join(' ');
    }
    return {fam,giv,eng};
  }

  function keysForDisp(disp){
    const {fam,giv,eng} = parseDisp(disp);
    const K = new Set(), add=v=>{ v=(v||'').trim(); if(v) K.add(norm(v)); };
    add(eng); add(giv);
    add(eng+' '+fam); add(eng+fam);
    add(giv+' '+fam); add(giv+fam);
    add(fam+' '+giv);
    if (fam){ add(eng+' '+fam[0]); add(giv+' '+fam[0]); add(eng+fam[0]); add(giv+fam[0]); }
    add(disp);
    return K;
  }

  const rows = Array.from(document.querySelectorAll('.table-panel .table tbody tr, .table tbody tr'))
    .map(el => el.tagName==='TR' ? el : el.closest('tr'))
    .filter(Boolean);

  let filled=0, matched=0, unmatched=0, seen=0;

  for (const tr of rows){
    if (tr.classList.contains('paddedquickfill') || tr.querySelector('#id_grade')) continue;
    const a = tr.querySelector('a[href*="/gp/st/"], a[href*="/st/"]');
    if (!a) continue;
    seen++;
    const disp = (a.textContent||'').trim();
    const keys = keysForDisp(disp);

    let value='';
    for (const k of keys){ if (Object.prototype.hasOwnProperty.call(keyMap,k)) { value = keyMap[k]; break; } }

    const input = tr.querySelector('input[name$="-grade"], input.input-small.form-control[type="text"], input[type="text"]');
    if (input && value!==''){
      input.value = value;
      input.dispatchEvent(new Event('input',{bubbles:true}));
      input.dispatchEvent(new Event('change',{bubbles:true}));
      matched++; filled++;
    } else {
      unmatched++;
    }
  }

  console.log('[ThinkWave Autofill] rows:', seen, 'matched:', matched, 'filled:', filled, 'unmatched:', unmatched);
})();`.trim();
  };

  // CSV DOWNLOAD /////////////////////////////////////////////////////////
  const downloadCSV = () => {
    const now = new Date();
    const pad = n=>String(n).padStart(2,'0');
    const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
    const subj = adhoc.active ? 'Adhoc' : tidy(activeSubject?.name||'Roster');
    const name = `${subj.replace(/[^a-z0-9]+/gi,'_')}_${stamp}.csv`;
    const blob = new Blob([els.csvOut.value||''], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  };

  // TOEFL ‚Üí GPA (Speaking 0‚Äì30 ‚Üí 55‚Äì100)
  // Anchors: ‚â§7‚Üí55, 16‚Üí80, 21‚Üí90, 25‚Üí95, ‚â•29‚Üí100
  const toGpa = (x) => {
    const n = Math.max(0, Math.min(30, Number(x)||0));
    if (n <= 7) return 55;                                           // flat floor
    if (n < 16) return Math.round(55 + (n-7)   * (80-55) / (16-7));  // 7..16 ‚Üí 55..80
    if (n < 21) return Math.round(80 + (n-16)  * (90-80) / (21-16)); // 16..21 ‚Üí 80..90
    if (n < 25) return Math.round(90 + (n-21)  * (95-90) / (25-21)); // 21..25 ‚Üí 90..95
    if (n < 29) return Math.round(95 + (n-25)  * (100-95)/(29-25));  // 25..29 ‚Üí 95..100
    return 100;                                                      // 29..30 ‚Üí 100
  };

  /*
  Exact conversion table (integer TOEFL ‚Üí GPA):
  0‚Äì7: 55
  8: 58
  9: 61
  10: 63
  11: 66
  12: 69
  13: 72
  14: 74
  15: 77
  16: 80
  17: 82
  18: 84
  19: 86
  20: 88
  21: 90
  22: 91
  23: 92
  24: 94
  25: 95
  26: 96
  27: 98
  28: 99
  29: 100
  30: 100
  */

  
  const convertToefl = () => {
    // Do NOT rewrite the textarea; just organize with conversion
    organize(true, toGpa); // <‚Äî pass the converter function
  };

  // IELTS (band 1..9 incl. halves) ‚Üí GPA 55..100 with calibrated anchors.
  // Revised anchors to satisfy: 6.5‚Üí90, 8.0‚Üí97, 8.5‚Üí99, 9.0‚Üí100
  const ieltsToGpa = (x) => {
    const b = Math.max(1, Math.min(9, Number(x)||0));
    const anchors = [
      [1.0, 55],
      [4.0, 70],
      [5.0, 78],
      [6.0, 88],
      [6.5, 90],  // NEW anchor
      [7.0, 92],
      [7.5, 95],
      [8.0, 97],
      [8.5, 99],
      [9.0, 100]
    ];
    // find surrounding segment and interpolate
    let lo = anchors[0], hi = anchors[anchors.length-1];
    for (let i = 0; i < anchors.length; i++) {
      if (b <= anchors[i][0]) { hi = anchors[i]; lo = anchors[i-1] || anchors[i]; break; }
    }
    if (lo[0] === hi[0]) return Math.round(lo[1]);
    const t = (b - lo[0]) / (hi[0] - lo[0]);
    return Math.round(lo[1] + t * (hi[1] - lo[1]));
  };


  const convertIelts = () => {
    organize(true, ieltsToGpa); // non-destructive; uses converted values for CSV + autofill
  };


  // EVENTS ///////////////////////////////////////////////////////////////
  document.getElementById('btnDownload').addEventListener('click', downloadCSV);
  els.btnOrganize.addEventListener('click', ()=>organize(true,false));
  els.btnToefl.addEventListener('click', convertToefl);
  els.btnIelts.addEventListener('click', convertIelts);


  // Paste Roster Order
  els.btnPasteOrder.addEventListener('click', ()=>{
    els.orderArea.classList.toggle('active');
  });
  els.btnApplyOrder?.addEventListener('click', ()=>{
    orderOverride = {lines: els.orderInput.value.split(/\n+/).map(s=>s.trim()).filter(Boolean)};
    recomputeOrderMap();
    buildRosterKeys();
    if (els.scoresInput.value.trim()) organize(false);
  });

  // Ad-hoc roster
  els.btnAdhoc.addEventListener('click', ()=>{ els.adhocArea.classList.toggle('active'); });
  els.btnUseAdhoc.addEventListener('click', ()=>{
    const lines = els.adhocInput.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    if (!lines.length){ adhoc.active=false; toast('Ad-hoc list is empty'); return; }

    lastSubjectId = activeSubject?.id ?? lastSubjectId; // remember the previous subject (if any)

    adhoc.active = true; adhoc.lines = lines.slice();
    activeSubject = null;
    roster = lines.map(name => ({display:name}));
    buildRosterKeys();
    // Clear any previous custom order and recompute if needed
    orderOverride = null;
    refreshRosterUI();
    if (els.scoresInput.value.trim()) organize(false);
  });

  // 1.0
  // els.btnClearAdhoc.addEventListener('click', ()=>{
  //   adhoc.active = false; adhoc.lines = []; els.adhocInput.value = '';
  //   // Keep current subject roster as-is; just refresh UI
  //   refreshRosterUI();
  //   if (els.scoresInput.value.trim()) organize(false);
  // });
    // 2.0
    els.btnClearAdhoc.addEventListener('click', ()=>{
    adhoc.active = false; 
    adhoc.lines = []; 
    els.adhocInput.value = '';

    // If we have a remembered subject that still exists in the loaded JSON, restore it.
    if (lastSubjectId && (data?.subjects || []).some(s => String(s.id) === String(lastSubjectId))) {
      selectSubject(lastSubjectId);
    } else {
      // Otherwise, truly clear to avoid the ‚Äúnames shown but organize() blocked‚Äù limbo.
      activeSubject = null;
      roster = [];
      rosterKeys = [];
      orderOverride = null;
      refreshRosterUI();
    }

    if (els.scoresInput.value.trim()) organize(false);
  });


  // File input
  els.file.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{ const txt = await f.text(); const json = JSON.parse(txt); data = json; localStorage.setItem(cacheKey, JSON.stringify(json)); loadSubjects(); toast('JSON loaded ‚úì'); }
    catch(err){ alert('Invalid JSON.'); }
  });

  // Clear cache
  els.clearCache.addEventListener('click', ()=>{
    localStorage.removeItem(cacheKey);
    toast('Cache cleared');
  });

  // If cache exists, hydrate
  (function init(){
    try{ const j = JSON.parse(localStorage.getItem(cacheKey)||'null'); if(j){ data=j; loadSubjects(); }
    }catch{}
  })();
})();
</script>
</body>
</html>
